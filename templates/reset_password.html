{% extends 'base.html' %}
{% block content %}
<div class="row justify-content-center">
  <div class="col-md-6">
    <div class="card shadow-sm">
      <div class="card-body">
        <h3 class="text-center mb-4">Reset Password</h3>
        <p class="text-muted text-center">
          Verify your phone number with OTP and set a new password.
        </p>

        <!-- Reset Form -->
        <form id="resetForm" method="POST" action="{{ url_for('reset_password') }}">
          <!-- Phone Input -->
          <div class="mb-3">
            <label class="form-label">Phone Number</label>
            <input type="text" class="form-control" id="phone" name="phone" placeholder="+91XXXXXXXXXX" required>
          </div>

          <!-- reCAPTCHA -->
          <div id="recaptcha-container" class="mb-3"></div>

          <!-- Send OTP -->
          <button type="button" id="sendOtpBtn" class="btn btn-primary w-100 mb-3">
            Send OTP
          </button>

          <!-- OTP Section -->
          <div id="otpSection" style="display: none;">
            <div class="mb-3">
              <label class="form-label">Enter OTP</label>
              <input type="text" class="form-control" id="otp" placeholder="Enter the OTP" required>
            </div>
            <button type="button" id="verifyOtpBtn" class="btn btn-success w-100 mb-3">
              Verify OTP
            </button>
          </div>

          <!-- Password Section -->
          <div id="passwordSection" style="display: none;">
            <div class="mb-3">
              <label class="form-label">New Password</label>
              <input type="password" class="form-control" name="password" id="password" required>
            </div>
            <div class="mb-3">
              <label class="form-label">Confirm Password</label>
              <input type="password" class="form-control" name="confirm" id="confirm" required>
            </div>
            <button type="submit" class="btn btn-primary w-100">Set New Password</button>
          </div>
        </form>

        <!-- Back to login -->
        <div class="text-center mt-3">
          <a href="{{ url_for('login') }}">Back to Login</a>
        </div>

        <!-- Status Message -->
        <div id="statusMsg" class="text-center mt-3 fw-bold"></div>
      </div>
    </div>
  </div>
</div>

<!-- Firebase OTP Script -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-app.js";
  import { getAuth, RecaptchaVerifier, signInWithPhoneNumber } from "https://www.gstatic.com/firebasejs/12.3.0/firebase-auth.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDpS0k1ZEqHI3TrwNjDIoXVtsbKQaSYItY",
    authDomain: "eyelume.firebaseapp.com",
    projectId: "eyelume",
    storageBucket: "eyelume.firebasestorage.app",
    messagingSenderId: "3722189197",
    appId: "1:3722189197:web:387eda213d158f5cb105c4"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);

  // Setup reCAPTCHA
  window.recaptchaVerifier = new RecaptchaVerifier(auth, "recaptcha-container", {
    size: "normal",
    callback: (response) => {
      console.log("reCAPTCHA verified");
    },
    "expired-callback": () => {
      alert("reCAPTCHA expired. Please try again.");
    }
  });

  let confirmationResult;

  // Send OTP
  document.getElementById("sendOtpBtn").addEventListener("click", () => {
    const phone = document.getElementById("phone").value.trim();
    const statusMsg = document.getElementById("statusMsg");

    if (!phone.startsWith("+")) {
      alert("Enter phone number with country code (e.g., +91XXXXXXXXXX)");
      return;
    }

    document.getElementById("sendOtpBtn").disabled = true;
    statusMsg.innerHTML = "Sending OTP...";

    signInWithPhoneNumber(auth, phone, window.recaptchaVerifier)
      .then((result) => {
        confirmationResult = result;
        statusMsg.innerHTML = "<span class='text-success'>OTP sent successfully ✅</span>";
        document.getElementById("otpSection").style.display = "block";
      })
      .catch((error) => {
        statusMsg.innerHTML = "<span class='text-danger'>Error: " + error.message + "</span>";
        document.getElementById("sendOtpBtn").disabled = false;
      });
  });

  // Verify OTP
  document.getElementById("verifyOtpBtn").addEventListener("click", () => {
    const otp = document.getElementById("otp").value.trim();
    const statusMsg = document.getElementById("statusMsg");

    if (!otp) {
      alert("Please enter OTP");
      return;
    }

    statusMsg.innerHTML = "Verifying OTP...";

    confirmationResult.confirm(otp)
      .then(() => {
        statusMsg.innerHTML = "<span class='text-success'>Phone verified ✅</span>";
        document.getElementById("passwordSection").style.display = "block";
      })
      .catch(() => {
        statusMsg.innerHTML = "<span class='text-danger'>Invalid OTP ❌ Please try again.</span>";
      });
  });
</script>
{% endblock %}
